---
layout: post
title: "How kafka manages consumers" 
description: ""
category: 
tags: [kafka]
---

* Fetch thread to pull msgs. Heartbeat thread to the broker
* Every consumer group has a coordinator on the broker. The coordinator manages the membership of consumers

### Kafka group states

* Empty: init state, no group member
* PreparingBalance
* InitialRebalance: delay entering PreparingBalance state to reduce rebalance times
* AwaitSync: waiting for the new assignment from the group leader
* Stable
* Dead: empty group. Metadata no longer available

### Rebalance consumer

When the consumer membership changes, Kafka will rebalance consumer to partition association 
 
* Coordinator replys the fetch request with rebalance notification
* SyncGroup: Consumer leader will rebalance and return to the coordinator, which in turn broadcast to other consumers
* JoinGroup: When new one joins the group
  * the coordinater will let the consumer group leader know the membership assignment, generaton
  * Other consumers will know the leader and generation


